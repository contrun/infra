- name: Initialize variables
  set_fact:
    env_vars: "{{ env_vars | default({}) }}"
    file_list: []

- name: Get env file list
  set_fact:
    file_list: "{{ file_list + [item] }}"
  with_fileglob:
    - "./{{ folder }}/.env*"
    # Make sure secret file is the last to read.
    - "./{{ folder }}/.env.secret"

- name: Read files
  slurp:
    src: '{{ item }}'
  ignore_errors: yes
  register: env_file_contents
  loop:
    "{{ file_list }}"

- name: Parse environment files
  set_fact:
    env_vars: "{{ env_vars | combine(('{' + (item.content | b64decode).split('\n') | select | map('regex_replace', '([^=]*)=(.*)', '\"\\1\": \"\\2\"') | join(',') + '}') | from_json) }}"
  when: not item.failed
  loop:
    "{{ env_file_contents.results }}"
